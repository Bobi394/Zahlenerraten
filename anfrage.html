<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anfrage senden ðŸ“¨</title>
<style>
body {
  background-color: #0f172a;
  color: white;
  font-family: Arial;
  text-align: center;
  padding: 30px;
}
h1 { color: #38bdf8; }
input, button {
  padding: 10px;
  margin: 8px;
  border-radius: 8px;
  border: none;
  font-size: 16px;
}
input {
  width: 200px;
  text-align: center;
}
button {
  background-color: #3b82f6;
  color: white;
  cursor: pointer;
}
button:hover { background-color: #2563eb; }
#langBtn {
  position: absolute;
  top: 10px;
  right: 15px;
  background: #1e293b;
  color: white;
  border-radius: 8px;
}
</style>
</head>
<body>
<button id="langBtn">ðŸ‡©ðŸ‡ª Deutsch</button>
<h1 id="title">ðŸ“¨ Anfrage senden</h1>
<p id="desc">Gib deinen Namen ein, um eine Anfrage zu stellen:</p>
<input type="text" id="nameInput" placeholder="Dein Name">
<button id="sendBtn">Anfrage senden</button>
<p id="status"></p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, push, set, onValue, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// ðŸ”¹ Firebase Einstellungen
const firebaseConfig = {
  apiKey: "AIzaSyBSDffrKz3_AE_iuwOLuZNB0yWLStMysSI",
  authDomain: "zahlenerraten.firebaseapp.com",
  databaseURL: "https://zahlenerraten-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "zahlenerraten",
  storageBucket: "zahlenerraten.firebasestorage.app",
  messagingSenderId: "143969932071",
  appId: "1:143969932071:web:850baabab3f9c0f2de0f02",
  measurementId: "G-KP89LYZJMT"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ðŸ”¹ HTML-Elemente
const title = document.getElementById("title");
const desc = document.getElementById("desc");
const nameInput = document.getElementById("nameInput");
const sendBtn = document.getElementById("sendBtn");
const status = document.getElementById("status");
const langBtn = document.getElementById("langBtn");

// ðŸ”¹ Sprachen
let lang = "de";
const texts = {
  de: {
    title: "ðŸ“¨ Anfrage senden",
    desc: "Gib deinen Namen ein, um eine Anfrage zu stellen:",
    placeholder: "Dein Name",
    send: "Anfrage senden",
    sending: "â³ Anfrage wird gesendet...",
    sent: "âœ… Anfrage wurde gesendet! Warte auf Antwort...",
    accepted: (url) => `âœ… Anfrage akzeptiert!<br><a href="${url}" target="_blank" style="color:#38bdf8;">Hier klicken ðŸ”‘</a>`,
    declined: "âŒ Deine Anfrage wurde abgelehnt!",
    exists: "âš ï¸ Du hast bereits eine offene Anfrage!",
    invalid: "âš ï¸ Bitte gib deinen Namen ein!",
    error: "âŒ Anfrage konnte nicht gespeichert werden!"
  },
  en: {
    title: "ðŸ“¨ Send Request",
    desc: "Enter your name to send a request:",
    placeholder: "Your name",
    send: "Send Request",
    sending: "â³ Sending request...",
    sent: "âœ… Request sent! Waiting for response...",
    accepted: (url) => `âœ… Request accepted!<br><a href="${url}" target="_blank" style="color:#38bdf8;">Click here ðŸ”‘</a>`,
    declined: "âŒ Request declined!",
    exists: "âš ï¸ You already have a pending request!",
    invalid: "âš ï¸ Please enter your name!",
    error: "âŒ Could not save request!"
  }
};

// ðŸ”¹ Sprache wechseln
langBtn.onclick = () => {
  lang = lang === "de" ? "en" : "de";
  langBtn.textContent = lang === "de" ? "ðŸ‡©ðŸ‡ª Deutsch" : "ðŸ‡¬ðŸ‡§ English";
  title.textContent = texts[lang].title;
  desc.textContent = texts[lang].desc;
  nameInput.placeholder = texts[lang].placeholder;
  sendBtn.textContent = texts[lang].send;
};
langBtn.click(); // Sprache initialisieren

// ðŸ”¹ PrÃ¼fen, ob schon offene Anfrage existiert
async function checkExisting(name) {
  const q = query(ref(db, "requests"), orderByChild("name"), equalTo(name));
  const snap = await get(q);
  if (!snap.exists()) return null;
  let found = null;
  snap.forEach(child => {
    if (child.val().status === "offen") found = { id: child.key, data: child.val() };
  });
  return found;
}

// ðŸ”¹ Anfrage absenden
sendBtn.onclick = async () => {
  const name = nameInput.value.trim();
  if (!name) return status.textContent = texts[lang].invalid;

  sendBtn.disabled = true;
  status.textContent = texts[lang].sending;

  try {
    const existing = await checkExisting(name);
    if (existing) {
      status.textContent = texts[lang].exists;
      sendBtn.disabled = false;
      return;
    }

    const newRef = push(ref(db, "requests"));
    await set(newRef, { name, status: "offen", timestamp: Date.now() });

    status.textContent = texts[lang].sent;
    nameInput.style.display = "none";
    sendBtn.style.display = "none";

    // Live auf StatusÃ¤nderung hÃ¶ren
    onValue(ref(db, "requests/" + newRef.key), async (snap) => {
      if (!snap.exists()) return;
      const data = snap.val();
      if (data.status === "akzeptiert") {
        const settingsSnap = await get(ref(db, "settings/linkURL"));
        const url = settingsSnap.exists() ? settingsSnap.val() : "#";
        status.innerHTML = texts[lang].accepted(url);
      } else if (data.status === "abgelehnt") {
        status.textContent = texts[lang].declined;
      }
    });

  } catch (err) {
    console.error("Fehler beim Speichern:", err);
    status.textContent = texts[lang].error;
    sendBtn.disabled = false;
  }
};
</script>
</body>
</html>