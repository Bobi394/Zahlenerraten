<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anfrage senden ğŸ“¨</title>
<style>
body { background-color:#0f172a; color:white; font-family:Arial; text-align:center; padding:30px; }
h1 { color:#38bdf8; }
input, button { padding:10px; margin:8px; border-radius:8px; border:none; font-size:16px; }
input { width:200px; text-align:center; }
button { background-color:#3b82f6; color:white; cursor:pointer; }
button:hover { background-color:#2563eb; }
#langBtn { position:absolute; top:10px; right:15px; background:#1e293b; color:white; border-radius:8px; }
</style>
</head>
<body>

<button id="langBtn">ğŸ‡©ğŸ‡ª Deutsch</button>
<h1 id="title">ğŸ“¨ Anfrage senden</h1>
<p id="desc">Gib deinen Namen ein, um eine Anfrage zu stellen:</p>
<input type="text" id="nameInput" placeholder="Dein Name">
<button id="sendBtn">Anfrage senden</button>
<p id="status"></p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, push, set, onValue, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

document.addEventListener("DOMContentLoaded", () => {

const firebaseConfig = {
  apiKey: "AIzaSyBSDffrKz3_AE_iuwOLuZNB0yWLStMysSI",
  authDomain: "zahlenerraten.firebaseapp.com",
  databaseURL: "https://zahlenerraten-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "zahlenerraten",
  storageBucket: "zahlenerraten.firebasestorage.app",
  messagingSenderId: "143969932071",
  appId: "1:143969932071:web:850baabab3f9c0f2de0f02"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Elemente
const title = document.getElementById("title");
const desc = document.getElementById("desc");
const nameInput = document.getElementById("nameInput");
const sendBtn = document.getElementById("sendBtn");
const status = document.getElementById("status");
const langBtn = document.getElementById("langBtn");

let lang="de";
let currentRequestId=null;

// Texte
const texts = {
  de: {
    title:"ğŸ“¨ Anfrage senden",
    desc:"Gib deinen Namen ein, um eine Anfrage zu stellen:",
    placeholder:"Dein Name",
    send:"Anfrage senden",
    sending:"â³ Anfrage wird gesendet...",
    sent:"âœ… Anfrage wurde gesendet! Warte auf Antwort...",
    accepted:(url)=>`âœ… Deine Anfrage wurde akzeptiert!<br><a href="${url}" target="_blank" style="color:#38bdf8;">Hier klicken, um das Passwort zu sehen ğŸ”‘</a>`,
    declined:"âŒ Deine Anfrage wurde abgelehnt!",
    exists:"âš ï¸ Du hast bereits eine offene Anfrage!",
    invalid:"âš ï¸ Bitte gib deinen Namen ein!"
  },
  en: {
    title:"ğŸ“¨ Send Request",
    desc:"Enter your name to send a request:",
    placeholder:"Your name",
    send:"Send Request",
    sending:"â³ Sending request...",
    sent:"âœ… Request sent! Please wait for a response...",
    accepted:(url)=>`âœ… Your request has been accepted!<br><a href="${url}" target="_blank" style="color:#38bdf8;">Click here to view the password ğŸ”‘</a>`,
    declined:"âŒ Your request was declined!",
    exists:"âš ï¸ You already have a pending request!",
    invalid:"âš ï¸ Please enter your name!"
  }
};

// Sprachumschalter
langBtn.onclick = ()=>{
  lang = lang==="de"?"en":"de";
  langBtn.textContent = lang==="de"?"ğŸ‡©ğŸ‡ª Deutsch":"ğŸ‡¬ğŸ‡§ English";
  applyLang();
};

function applyLang(){
  title.textContent=texts[lang].title;
  desc.textContent=texts[lang].desc;
  nameInput.placeholder=texts[lang].placeholder;
  sendBtn.textContent=texts[lang].send;
}

// PrÃ¼ft offene Anfrage
async function checkExisting(name){
  const q = query(ref(db,"requests"), orderByChild("name"), equalTo(name));
  const snap = await get(q);
  if(!snap.exists()) return null;
  let foundId=null;
  snap.forEach(child=>{
    if(child.val().status==="offen") foundId=child.key;
  });
  return foundId?foundId:null;
}

// Anfrage senden
sendBtn.onclick = async ()=>{
  const name=nameInput.value.trim();
  if(!name){ status.textContent=texts[lang].invalid; return; }
  status.textContent=texts[lang].sending;
  sendBtn.disabled=true;

  const existing = await checkExisting(name);
  if(existing){ status.textContent=texts[lang].exists; sendBtn.disabled=false; return; }

  try{
    const newReq = push(ref(db,"requests"));
    await set(newReq,{name,status:"offen"});
    currentRequestId=newReq.key;
    status.textContent=texts[lang].sent;

    onValue(ref(db,"requests/"+currentRequestId),(snap)=>{
      if(!snap.exists()) return;
      const data=snap.val();
      if(data.status==="akzeptiert"){
        const url = "#"; // Hier kÃ¶nnte Link aus Einstellungen kommen
        status.innerHTML=texts[lang].accepted(url);
        sendBtn.style.display="none"; nameInput.style.display="none";
      } else if(data.status==="abgelehnt"){
        status.textContent=texts[lang].declined;
        sendBtn.style.display="none"; nameInput.style.display="none";
      }
    });
  } catch(err){
    status.textContent="âŒ Anfrage konnte nicht gespeichert werden!";
    console.error(err);
  }
};

applyLang();

});
</script>
</body>
</html>