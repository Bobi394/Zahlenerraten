<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roblox Anfrage ğŸ•¹ï¸</title>
<style>
body {
  background-color: #0f172a;
  color: white;
  font-family: Arial;
  text-align: center;
  padding: 30px;
}
h1 { color: #38bdf8; }
input, button {
  padding: 10px;
  margin: 8px;
  border-radius: 8px;
  border: none;
  font-size: 16px;
}
input {
  width: 220px;
  text-align: center;
}
button {
  background-color: #3b82f6;
  color: white;
  cursor: pointer;
}
button:hover { background-color: #2563eb; }
#langBtn {
  position: absolute;
  top: 10px;
  right: 15px;
  background: #1e293b;
  color: white;
  border-radius: 8px;
}
</style>
</head>
<body>
<button id="langBtn">ğŸ‡©ğŸ‡ª Deutsch</button>
<h1 id="title">ğŸ•¹ï¸ Roblox Anfrage</h1>
<p id="desc">Gib deinen Roblox-Benutzernamen ein, um eine Anfrage zu stellen:</p>
<input type="text" id="nameInput" placeholder="Dein Roblox-Name">
<button id="sendBtn">Anfrage senden</button>
<p id="status"></p>

<script type="module">
const firebaseConfig = {
  apiKey: "AIzaSyBSDffrKz3_AE_iuwOLuZNB0yWLStMysSI",
  authDomain: "zahlenerraten.firebaseapp.com",
  databaseURL: "https://zahlenerraten-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "zahlenerraten",
  storageBucket: "zahlenerraten.firebasestorage.app",
  messagingSenderId: "143969932071",
  appId: "1:143969932071:web:850baabab3f9c0f2de0f02",
  measurementId: "G-KP89LYZJMT"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, push, set, onValue, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const title = document.getElementById("title");
const desc = document.getElementById("desc");
const nameInput = document.getElementById("nameInput");
const sendBtn = document.getElementById("sendBtn");
const status = document.getElementById("status");
const langBtn = document.getElementById("langBtn");

let lang = "de";
let currentRequestId = null;

// ğŸ—£ Texte
const texts = {
  de: {
    title: "ğŸ•¹ï¸ Roblox Anfrage",
    desc: "Gib deinen Roblox-Benutzernamen ein, um eine Anfrage zu stellen:",
    placeholder: "Dein Roblox-Name",
    send: "Anfrage senden",
    sending: "â³ Anfrage wird gesendet...",
    sent: "âœ… Anfrage wurde gesendet! Warte, bis sie Ã¼berprÃ¼ft wurde...",
    accepted: (url) => `âœ… Deine Anfrage wurde akzeptiert!<br><a href="${url}" target="_blank" style="color:#38bdf8;">Hier klicken, um deine Belohnung zu sehen ğŸ</a>`,
    declined: "âŒ Deine Anfrage wurde abgelehnt!",
    exists: "âš ï¸ Du hast bereits eine offene Anfrage!",
    invalid: "âš ï¸ Bitte gib deinen Roblox-Namen ein!"
  },
  en: {
    title: "ğŸ•¹ï¸ Roblox Request",
    desc: "Enter your Roblox username to send a request:",
    placeholder: "Your Roblox name",
    send: "Send Request",
    sending: "â³ Sending request...",
    sent: "âœ… Request sent! Please wait for it to be reviewed...",
    accepted: (url) => `âœ… Your request has been accepted!<br><a href="${url}" target="_blank" style="color:#38bdf8;">Click here to view your reward ğŸ</a>`,
    declined: "âŒ Your request was declined!",
    exists: "âš ï¸ You already have a pending request!",
    invalid: "âš ï¸ Please enter your Roblox name!"
  }
};

// ğŸŸ¦ Sprachumschalter
langBtn.onclick = () => {
  lang = lang === "de" ? "en" : "de";
  langBtn.textContent = lang === "de" ? "ğŸ‡©ğŸ‡ª Deutsch" : "ğŸ‡¬ğŸ‡§ English";
  applyLang();
};

function applyLang() {
  title.textContent = texts[lang].title;
  desc.textContent = texts[lang].desc;
  nameInput.placeholder = texts[lang].placeholder;
  sendBtn.textContent = texts[lang].send;
}

// ğŸ”¹ PrÃ¼fen, ob es schon eine offene Anfrage gibt
async function checkExisting(name) {
  const q = query(ref(db, "requests"), orderByChild("name"), equalTo(name));
  const snap = await get(q);
  if (!snap.exists()) return null;

  let foundId = null;
  snap.forEach(child => {
    const val = child.val();
    if (val.status === "offen") {
      foundId = child.key;
    }
  });
  return foundId;
}

// ğŸ”¹ Anfrage senden
sendBtn.onclick = async () => {
  const name = nameInput.value.trim();
  if (!name) {
    status.textContent = texts[lang].invalid;
    return;
  }

  status.textContent = texts[lang].sending;
  sendBtn.disabled = true;

  const existing = await checkExisting(name);
  if (existing) {
    status.textContent = texts[lang].exists;
    sendBtn.disabled = false;
    return;
  }

  const newReq = push(ref(db, "requests"));
  await set(newReq, { name, status: "offen" });
  currentRequestId = newReq.key;
  status.textContent = texts[lang].sent;

  // ğŸ”¹ Beobachten, ob Admin akzeptiert
  onValue(ref(db, "requests/" + currentRequestId), async (snap) => {
    if (!snap.exists()) return;
    const data = snap.val();
    if (data.status === "akzeptiert") {
      const settingsSnap = await get(ref(db, "settings/linkURL"));
      const url = settingsSnap.exists() ? settingsSnap.val() : "#";
      status.innerHTML = texts[lang].accepted(url);
      sendBtn.style.display = "none";
      nameInput.style.display = "none";
    } else if (data.status === "abgelehnt") {
      status.textContent = texts[lang].declined;
      sendBtn.style.display = "none";
      nameInput.style.display = "none";
    }
  });
};

// Sprache einstellen
applyLang();
</script>
</body>
</html>