<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Zahlen-RÃ¤tsel â€” (Reload Debug)</title>
<style>
  body{font-family:Arial;background:#0f172a;color:#fff;text-align:center;padding:30px}
  h1{color:#38bdf8}
  input,button{padding:10px;margin:8px;border-radius:8px;border:none;font-size:16px}
  #statusBox{margin-top:12px;padding:10px;border-radius:8px;background:#111827;color:#fff}
  #reloadNotice{margin-top:12px;color:#ffd166;font-weight:bold}
</style>
</head>
<body>
  <h1>ðŸ”¢ Zahlen erraten</h1>
  <p id="rangeText">Lade Einstellungenâ€¦</p>
  <input type="number" id="guess" placeholder="Zahl">
  <button id="guessBtn">Raten</button>
  <div id="statusBox">Status: bereit</div>
  <div id="reloadNotice" style="display:none">Admin fordert Reload â€” Seite wird neu geladenâ€¦</div>

<script type="module">
// Imports (wichtig: onValue ist importiert)
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBSDffrKz3_AE_iuwOLuZNB0yWLStMysSI",
  authDomain: "zahlenerraten.firebaseapp.com",
  databaseURL: "https://zahlenerraten-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "zahlenerraten",
  storageBucket: "zahlenerraten.firebasestorage.app",
  messagingSenderId: "143969932071",
  appId: "1:143969932071:web:850baabab3f9c0f2de0f02"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// UI
const rangeText = document.getElementById("rangeText");
const statusBox = document.getElementById("statusBox");
const reloadNotice = document.getElementById("reloadNotice");

// Spiel-variablen (vereinfachte Version)
let settings = {};
let currentNumber = 0;
let attemptsLeft = 0;

// Hilfsfunktion: setze Status sichtbar
function setStatus(text){
  statusBox.textContent = "Status: " + text;
}

// Lade Einstellungen (und starte Spiel)
async function loadSettings(){
  try{
    const snap = await get(ref(db, "settings"));
    console.log("settings.exists:", snap.exists(), " value:", snap.val());
    if(snap.exists()){
      settings = snap.val();
      rangeText.textContent = `Errate die Zahl zwischen ${settings.minNumber} und ${settings.maxNumber}`;
      startGame();
      setStatus("Einstellungen geladen");
    } else {
      rangeText.textContent = "âŒ Einstellungen nicht gefunden (Pfad: settings)";
      setStatus("Einstellungen fehlen");
    }
  } catch(e){
    console.error("Fehler loadSettings:", e);
    rangeText.textContent = "âŒ Fehler beim Laden der Einstellungen";
    setStatus("Fehler beim Laden");
  }
}

function startGame(){
  const min = settings.minNumber || 1;
  const max = settings.maxNumber || 50;
  const isRandom = settings.randomNumber;
  currentNumber = isRandom ? Math.floor(Math.random()*(max-min+1))+min : Number(settings.fixedNumber)||10;
  attemptsLeft = settings.maxAttempts || 5;
}

// ---- Robust Reload-Listener ----
// Wir hÃ¶ren auf reloadFlag/time. Vergleich als STRING, damit types keine Probleme machen.
// firstSeen speichert initialen Zeitwert â€” beim ersten Empfang soll nicht neu geladen werden.
const reloadRef = ref(db, "reloadFlag/time");
let firstSeen = null;

onValue(reloadRef, (snapshot) => {
  // Wenn kein Wert vorhanden: nichts tun
  if(!snapshot.exists()){
    console.log("reloadFlag/time nicht vorhanden");
    return;
  }

  // Konvertiere in String (sicher gegen number/string Unterschiede)
  const newTimeRaw = snapshot.val();
  const newTimeStr = String(newTimeRaw);
  const lastStored = localStorage.getItem("lastReloadTime");

  console.log("onValue reloadFlag/time:", newTimeRaw, " lastStored:", lastStored, " firstSeen:", firstSeen);

  // Wenn das der erste Empfang ist (erste Seite-Messung), merken wir ihn, aber reloaden nicht
  if(firstSeen === null){
    firstSeen = newTimeStr;
    // Falls localStorage leer, setzen wir ihn â€” das verhindert direktes Reloaden beim ersten load.
    if(!lastStored){
      localStorage.setItem("lastReloadTime", newTimeStr);
      console.log("Initial lastReloadTime gesetzt ->", newTimeStr);
    }
    return;
  }

  // Vergleich mit lokal gespeicherter Zeit (string)
  const lastReload = localStorage.getItem("lastReloadTime") || "";
  if(newTimeStr !== lastReload){
    // Sichtbares Feedback (hilft auf Handy ohne Konsole)
    reloadNotice.style.display = "block";
    reloadNotice.textContent = "Admin fordert Reload â€” Seite wird neu geladenâ€¦";

    // Update localStorage direkt (verhindert double-reload loops)
    localStorage.setItem("lastReloadTime", newTimeStr);

    // kurze VerzÃ¶gerung, damit Nutzer die Meldung sieht (optional)
    setTimeout(()=> {
      location.reload();
    }, 600);
  } else {
    console.log("reloadFlag/time hat sich nicht geÃ¤ndert (neu==gespeichert)");
  }
});

// Utility: Entwicklerhilfe â€” falls du testen willst, kannst du localStorage zurÃ¼cksetzen:
// localStorage.removeItem("lastReloadTime"); setStatus("localStorage zurÃ¼ckgesetzt");

loadSettings();
</script>
</body>
</html>